<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudsoft Inventory & Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable plugin for table generation in PDF -->
    <script src="https://unpkg.com/jspdf-autotable@3.5.20/dist/jspdf.plugin.autotable.js"></script>
 <!-- Favicon: Using the new Cloudsoft logo image -->
    <link rel="icon" type="image/jpeg" href="https://github.com/tacsecurityservices/Cloudsoft/blob/main/WhatsApp%20Image%202025-06-24%20at%2011.41.03.jpeg?raw=true">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Slate, Zinc, Stone) -->
    <!-- Application Structure Plan: This application combines a business management tool (Inventory, Tasks, Expenses) with a product catalogue. The structure uses a tabbed navigation approach for the main sections (Inventory, Tasks, Expenses, Catalogue). Each section is a distinct content block, hidden by default and revealed when its corresponding navigation button is clicked. The Catalogue section specifically features product cards displaying both Cost Price (CP) and Selling Price (SP), along with filter controls, a grouped bar chart for visual comparison, a form to add products that are saved locally, and now a delete option for catalogue products. This design allows users to switch between different business functions and product insights seamlessly within a single page, providing a comprehensive management and informational tool. -->
    <!-- Visualization & Content Choices: 
        - Report Info (Inventory): Product Stock (Name, Qty, CP, SP). Goal: Manage & Summarize.
        - Viz/Presentation (Inventory): Table (HTML) for detailed item management, Donut Chart (Chart.js/Canvas) for visual distribution of inventory value.
        - Interaction (Inventory): Add/Edit/Delete items, Search, Filter by Category.
        - Justification (Inventory): Table provides granular control, donut chart offers a quick visual summary of value distribution.
        - Library/Method (Inventory): Chart.js, Vanilla JS.

        - Report Info (Catalogue): Fixed Product Data (Name, Specs, Cost Price, Selling Price) and now user-added products. Goal: Inform & Compare, Add Data, Delete Data.
        - Viz/Presentation (Catalogue): Product Cards (HTML/Tailwind) for clear display of product details including CP and SP, Grouped Bar Chart (Chart.js/Canvas) for direct CP vs. SP comparison, Form (HTML/Tailwind) for data input.
        - Interaction (Catalogue): Filter by product type (Toilet Paper, Refuse Bags, All), Add new products via form, Delete individual products.
        - Justification (Catalogue): Cards provide digestible product info, grouped bar chart is excellent for side-by-side metric comparison. Filtering enhances user focus. The new form allows for direct data entry and local persistence, making the catalogue dynamic and customizable. The delete option provides full management capability.
        - Library/Method (Catalogue): Chart.js, Vanilla JS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .inventory-chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
        }
        .catalogue-chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        @media (max-width: 768px) {
            .inventory-chart-container {
                height: 200px;
            }
            .catalogue-chart-container {
                height: 300px;
            }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10B981;
        }
        .notification.error {
            background-color: #EF4444;
        }
        .notification.info {
            background-color: #3B82F6;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3B82F6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom styles for mobile navigation */
        @media (max-width: 767px) {
            .mobile-nav-hidden {
                display: none;
            }
            .mobile-nav-show {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            .mobile-nav-show button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 text-gray-800 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loader"></div>
        <p class="text-gray-700 font-semibold text-lg">Loading data...</p>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Main App Content -->
    <div id="appContent" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-lg py-4 border-b border-gray-200">
            <div class="container mx-auto px-4 flex flex-wrap justify-between items-center">
                <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                    <div class= <img src="https://github.com/tacsecurityservices/Cloudsoft/blob/main/WhatsApp%20Image%202025-06-24%20at%2011.41.03.jpeg?raw=true" alt="Cloudsoft Logo" class="w-12 h-12 object-contain rounded-lg shadow-lg">
                    </div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Cloudsoft Business Manager</h1>
                </div>

                <!-- Hamburger menu for mobile -->
                <button id="mobile-menu-toggle" class="lg:hidden p-2 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>

                <nav id="main-nav" class="w-full lg:w-auto flex-col lg:flex-row lg:flex space-y-2 lg:space-y-0 lg:space-x-2 mobile-nav-hidden">
                    <button id="nav-inventory" class="px-6 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md">
                        ðŸ“¦ Inventory
                    </button>
                    <button id="nav-tasks" class="px-6 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-200">
                        âœ“ Tasks
                    </button>
                    <button id="nav-expenses" class="px-6 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-200">
                        ðŸ’¸ Expenses
                    </button>
                    <button id="nav-catalogue" class="px-6 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-200">
                        ðŸ“‹ Catalogue
                    </button>
                </nav>
            </div>
        </header>
        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Auto-save Status -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-2">
                    <span id="autoSaveStatus" class="text-sm text-green-600 font-medium">âœ“ Auto-save enabled</span>
                </div>
                <div class="flex flex-wrap justify-center sm:justify-end gap-2">
                    <button id="exportDataBtn" class="px-4 py-2 rounded-lg bg-purple-500 text-white font-semibold hover:bg-purple-600 transition-colors shadow-md">
                        ðŸ“„ Download
                    </button>
                    <button id="importDataBtn" class="px-4 py-2 rounded-lg bg-orange-500 text-white font-semibold hover:bg-orange-600 transition-colors shadow-md">
                        ðŸ“¤ Upload
                    </button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                </div>
            </div>
            <!-- Inventory Section -->
            <section id="inventory-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">ðŸ“¦ Inventory Management</h2>
                <p class="text-gray-600 mb-6 text-center text-sm sm:text-base">Manage product stock here. Add new items, update quantities, and keep track of inventory value.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add Inventory Form -->
                    <div class="p-6 border border-gray-200 rounded-xl bg-gradient-to-br from-gray-50 to-white shadow-sm">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm mr-2">+</span>
                            Add New Inventory Item
                        </h3>
                        <form id="inventoryForm" class="space-y-4">
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                                <input type="text" id="productName" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Enter product name" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                    <input type="number" id="quantity" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="0" required min="0">
                                </div>
                                <div>
                                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select id="category" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="1PLY">1PLY</option>
                                        <option value="2PLY (200 Sheets)">2PLY (200 Sheets)</option>
                                        <option value="2PLY (350 Sheets)">2PLY (350 Sheets)</option>
                                        <option value="Refuse Bags">Refuse Bags</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="costPrice" class="block text-sm font-medium text-gray-700 mb-1">Cost Price (R)</label>
                                    <input type="number" id="costPrice" step="0.01" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="0.00" required min="0">
                                </div>
                                <div>
                                    <label for="sellingPrice" class="block text-sm font-medium text-gray-700 mb-1">Selling Price (R)</label>
                                    <input type="number" id="sellingPrice" step="0.01" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="0.00" required min="0">
                                </div>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md">
                                Add Item
                            </button>
                        </form>
                    </div>
                    <!-- Inventory Summary & Chart -->
                    <div class="p-6 border border-gray-200 rounded-xl bg-gradient-to-br from-gray-50 to-white shadow-sm flex flex-col">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm mr-2">ðŸ“Š</span>
                            Financial Overview
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <p class="text-sm text-blue-600 font-medium">Total Cost Value</p>
                                <p id="totalCostValue" class="text-xl sm:text-2xl font-bold text-blue-700">R0.00</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <p class="text-sm text-green-600 font-medium">Total Selling Value</p>
                                <p id="totalSellingValue" class="text-xl sm:text-2xl font-bold text-green-700">R0.00</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <p class="text-sm text-red-600 font-medium">Total Expenses</p>
                                <p id="totalExpensesValue" class="text-xl sm:text-2xl font-bold text-red-700">R0.00</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <p class="text-sm text-purple-600 font-medium">Net Profit</p>
                                <p id="netProfitValue" class="text-xl sm:text-2xl font-bold text-purple-700">R0.00</p>
                            </div>
                            <!-- New: Total Inventory Count -->
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 col-span-full">
                                <p class="text-sm text-yellow-600 font-medium">Total Inventory Items</p>
                                <p id="totalInventoryCount" class="text-xl sm:text-2xl font-bold text-yellow-700">0</p>
                            </div>
                            <!-- End New: Total Inventory Count -->
                        </div>
                        <div class="flex-grow inventory-chart-container">
                            <canvas id="inventoryValueChart"></canvas>
                        </div>
                        <p class="text-sm text-gray-500 mt-4 text-center">Distribution of inventory value by product</p>
                    </div>
                </div>
                <!-- Search and Filter -->
                <div class="mt-8 flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div class="flex-1 w-full md:max-w-md">
                        <input type="text" id="searchInventory" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="ðŸ” Search inventory...">
                    </div>
                    <div class="flex flex-wrap justify-center gap-2">
                        <select id="filterCategory" class="border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="">All Categories</option>
                            <option value="1PLY">1PLY</option>
                            <option value="2PLY (200 Sheets)">2PLY (200 Sheets)</option>
                            <option value="2PLY (350 Sheets)">2PLY (350 Sheets)</option>
                            <option value="Refuse Bags">Refuse Bags</option>
                            <option value="Other">Other</option>
                        </select>
                        <button id="clearFilters" class="px-4 py-2 rounded-lg bg-gray-500 text-white font-semibold hover:bg-gray-600 transition-colors">
                            Clear
                        </button>
                    </div>
                </div>
                <!-- Inventory List -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Current Inventory</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gradient-to-r from-gray-100 to-gray-200 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Product Name</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Category</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Quantity</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Cost Price</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Selling Price</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Total Value</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryList" class="divide-y divide-gray-200">
                                <!-- Inventory items will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="noInventoryMessage" class="text-center text-gray-500 mt-8 hidden">
                        <span class="text-4xl">ðŸ“¦</span><br>
                        No inventory items found.<br>
                        <span class="text-sm">Add your first item using the form above.</span>
                    </p>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="tasks-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">âœ“ Task Management</h2>
                <p class="text-gray-600 mb-6 text-center text-sm sm:text-base">Keep track of business tasks. Add new tasks, mark them as complete, or edit details.</p>
                <div class="p-6 border border-gray-200 rounded-xl bg-gradient-to-br from-gray-50 to-white shadow-sm mb-8">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <span class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm mr-2">+</span>
                        Add New Task
                    </h3>
                    <form id="taskForm" class="space-y-4">
                        <div>
                            <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">Task Description</label>
                            <textarea id="taskDescription" rows="3" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Enter task description..." required></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                <input type="date" id="taskDueDate" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                            <div>
                                <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                <select id="taskPriority" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-md">
                            Add Task
                        </button>
                    </form>
                </div>
                <!-- Task Filters -->
                <div class="flex flex-wrap gap-2 mb-6 justify-center sm:justify-start">
                    <button id="filterAll" class="px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors text-sm">All</button>
                    <button id="filterPending" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition-colors text-sm">Pending</button>
                    <button id="filterCompleted" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition-colors text-sm">Completed</button>
                    <button id="filterHigh" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition-colors text-sm">High Priority</button>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Current Tasks</h3>
                    <div id="taskList" class="space-y-4">
                        <!-- Tasks will be rendered here -->
                    </div>
                    <p id="noTasksMessage" class="text-center text-gray-500 mt-8 hidden">
                        <span class="text-4xl">ðŸ“‹</span><br>
                        No tasks found.<br>
                        <span class="text-sm">Add your first task using the form above.</span>
                    </p>
                </div>
            </section>

            <!-- Expenses Section -->
            <section id="expenses-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">ðŸ’¸ Expense Management</h2>
                <p class="text-gray-600 mb-6 text-center text-sm sm:text-base">Track your business expenses to get a clearer picture of net profit.</p>
                <div class="p-6 border border-gray-200 rounded-xl bg-gradient-to-br from-gray-50 to-white shadow-sm mb-8">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <span class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white text-sm mr-2">+</span>
                        Add New Expense
                    </h3>
                    <form id="expenseForm" class="space-y-4">
                        <div>
                            <label for="expenseName" class="block text-sm font-medium text-gray-700 mb-1">Expense Name</label>
                            <input type="text" id="expenseName" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="e.g., Office Rent, Marketing, Utilities" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount (R)</label>
                                <input type="number" id="expenseAmount" step="0.01" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="0.00" required min="0">
                            </div>
                            <div>
                                <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="expenseDate" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" required>
                            </div>
                        </div>
                        <div>
                            <label for="expenseCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="expenseCategory" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all">
                                <option value="Operating">Operating</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Salaries">Salaries</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-md">
                            Add Expense
                        </button>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Expense List</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gradient-to-r from-gray-100 to-gray-200 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Expense Name</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Category</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Amount</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Date</th>
                                    <th class="py-4 px-3 sm:px-6 border-b border-gray-200">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenseList" class="divide-y divide-gray-200">
                                <!-- Expenses will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="noExpensesMessage" class="text-center text-gray-500 mt-8 hidden">
                        <span class="text-4xl">ðŸ’¸</span><br>
                        No expenses recorded.<br>
                        <span class="text-sm">Add your first expense using the form above.</span>
                    </p>
                </div>
            </section>

            <!-- Product Catalogue Section -->
            <section id="catalogue-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">ðŸ“‹Product Catalogue</h2>
                <p class="text-gray-600 mb-6 text-center text-sm sm:text-base">View and compare Cloudsoft's product pricing.</p>
                
                <!-- Add Catalogue Product Form -->
                <div class="p-6 border border-gray-200 rounded-xl bg-gradient-to-br from-gray-50 to-white shadow-sm mb-8">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <span class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm mr-2">+</span>
                        <span id="catalogueFormTitle">Add New Catalogue Product</span>
                    </h3>
                    <form id="catalogueProductForm" class="space-y-4">
                        <div>
                            <label for="catalogueProductName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                            <input type="text" id="catalogueProductName" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Enter product name" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="catalogueSheets" class="block text-sm font-medium text-gray-700 mb-1">Sheets</label>
                                <input type="number" id="catalogueSheets" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="e.g., 200 or leave blank">
                            </div>
                            <div>
                                <label for="cataloguePlies" class="block text-sm font-medium text-gray-700 mb-1">Plies</label>
                                <input type="number" id="cataloguePlies" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="e.g., 2 or leave blank">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="catalogueCostPrice" class="block text-sm font-medium text-gray-700 mb-1">Cost Price (R)</label>
                                <input type="number" id="catalogueCostPrice" step="0.01" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="0.00" required min="0">
                            </div>
                            <div>
                                <label for="catalogueSellingPrice" class="block text-sm font-medium text-gray-700 mb-1">Selling Price (R)</label>
                                <input type="number" id="catalogueSellingPrice" step="0.01" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="0.00" required min="0">
                            </div>
                        </div>
                        <div>
                            <label for="catalogueCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="catalogueCategory" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="Toilet Paper">Toilet Paper</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button type="submit" id="catalogueSubmitBtn" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md">
                            Add Product to Catalogue
                        </button>
                    </form>
                </div>
                
                <!-- Catalogue Filters -->
                <div class="mb-8">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-700">Filter Products</h3>
                        <p class="text-md text-stone-500">Select a category to refine the products shown below.</p>
                    </div>
                    <div class="flex justify-center items-center gap-2 sm:gap-4">
                        <button data-filter="all" class="catalogue-filter-btn bg-slate-700 text-white py-2 px-5 rounded-full shadow-md hover:bg-slate-600 transition-colors duration-300">All Products</button>
                        <button data-filter="Toilet Paper" class="catalogue-filter-btn bg-white text-slate-700 py-2 px-5 rounded-full shadow-md hover:bg-stone-100 transition-colors duration-300">Toilet Paper</button>
                        <button data-filter="Other" class="catalogue-filter-btn bg-white text-slate-700 py-2 px-5 rounded-full shadow-md hover:bg-stone-100 transition-colors duration-300">Other</button>
                    </div>
                </div>

                <!-- Product Cards Section -->
                <div class="mb-12">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-700">Product Details</h3>
                        <p class="text-md text-stone-500">Here are the products based on your selection, including both cost and selling prices.</p>
                    </div>
                    <div id="catalogue-product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Product cards will be dynamically inserted here -->
                    </div>
                    <div id="catalogue-no-results" class="text-center py-12 text-stone-500 hidden">
                        <p class="text-xl">No products match the selected filter.</p>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="bg-stone-50 p-6 rounded-2xl shadow-sm">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-700">Cost vs. Selling Price Comparison</h3>
                        <p class="text-md text-stone-500">This chart visually compares the cost price and selling price for each product, highlighting potential profit margins.</p>
                    </div>
                    <div class="catalogue-chart-container">
                        <canvas id="cataloguePriceChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <script>
        // --- Application Data ---
        let inventory = [];
        let tasks = [];
        let expenses = [];
        let inventoryChart = null;
        let cataloguePriceChart = null; // Separate chart for catalogue
        let currentTaskFilter = 'all';
        let currentCatalogueFilter = 'all'; // Separate filter for catalogue
        let editingCatalogueProductId = null; // New: To track which catalogue product is being edited

        // Fixed product data for the catalogue (now mutable)
        let catalogueProductData = [
            { id: 1, name: 'Toilet Paper', sheets: 350, plies: 2, price: 4.69, cp: 3.50, category: 'Toilet Paper' },
            { id: 2, name: 'Toilet Paper', sheets: 200, plies: 2, price: 5.70, cp: 4.00, category: 'Toilet Paper' },
            { id: 3, name: 'Toilet Paper', sheets: null, plies: 1, price: 6.23, cp: 4.50, category: 'Toilet Paper' },
            { id: 4, name: 'Refuse Bags', sheets: null, plies: null, price: 18.70, cp: 12.00, category: 'Other' }
        ];

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const inventoryForm = document.getElementById('inventoryForm');
        const inventoryList = document.getElementById('inventoryList');
        const noInventoryMessage = document.getElementById('noInventoryMessage');
        const totalCostValue = document.getElementById('totalCostValue');
        const totalSellingValue = document.getElementById('totalSellingValue');
        const totalExpensesValue = document.getElementById('totalExpensesValue');
        const netProfitValue = document.getElementById('netProfitValue');
        const inventoryValueChartCanvas = document.getElementById('inventoryValueChart');
        const searchInventory = document.getElementById('searchInventory');
        const filterCategory = document.getElementById('filterCategory');
        const clearFilters = document.getElementById('clearFilters');
        const taskForm = document.getElementById('taskForm');
        const taskList = document.getElementById('taskList');
        const noTasksMessage = document.getElementById('noTasksMessage');
        const expenseForm = document.getElementById('expenseForm');
        const expenseList = document.getElementById('expenseList');
        const noExpensesMessage = document.getElementById('noExpensesMessage');

        // Main Navigation Buttons
        const navInventory = document.getElementById('nav-inventory');
        const navCatalogue = document.getElementById('nav-catalogue'); // New catalogue nav button
        const navTasks = document.getElementById('nav-tasks');
        const navExpenses = document.getElementById('nav-expenses');

        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const importFileInput = document.getElementById('importFileInput');
        const notification = document.getElementById('notification');
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        const totalInventoryCount = document.getElementById('totalInventoryCount');

        // Task Filter Buttons
        const filterAllTasks = document.getElementById('filterAll');
        const filterPendingTasks = document.getElementById('filterPending');
        const filterCompletedTasks = document.getElementById('filterCompleted');
        const filterHighTasks = document.getElementById('filterHigh');

        // Mobile Menu Toggle
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mainNav = document.getElementById('main-nav');

        // Catalogue specific DOM elements
        const catalogueProductForm = document.getElementById('catalogueProductForm'); // New form
        const catalogueFormTitle = document.getElementById('catalogueFormTitle'); // New: Title for add/edit form
        const catalogueProductName = document.getElementById('catalogueProductName');
        const catalogueSheets = document.getElementById('catalogueSheets');
        const cataloguePlies = document.getElementById('cataloguePlies');
        const catalogueCostPrice = document.getElementById('catalogueCostPrice');
        const catalogueSellingPrice = document.getElementById('catalogueSellingPrice');
        const catalogueCategory = document.getElementById('catalogueCategory');
        const catalogueSubmitBtn = document.getElementById('catalogueSubmitBtn'); // New: Submit button for catalogue form

        const catalogueProductGrid = document.getElementById('catalogue-product-grid');
        const catalogueNoResultsMessage = document.getElementById('catalogue-no-results');
        const catalogueFilterButtons = document.querySelectorAll('#catalogue-section .catalogue-filter-btn');
        const cataloguePriceChartCanvas = document.getElementById('cataloguePriceChart');


        // --- Utility Functions ---
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(message = 'Loading data...') {
            loadingOverlay.querySelector('p').textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function wrapLabel(label, maxLength = 16) {
            if (label.length <= maxLength) {
                return label;
            }
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            for (let word of words) {
                if ((currentLine + word).length > maxLength && currentLine.length > 0) {
                    lines.push(currentLine.trim());
                    currentLine = word + ' ';
                } else {
                    currentLine += word + ' ';
                }
            }
            lines.push(currentLine.trim());
            return lines;
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'High': return 'bg-red-100 border-red-300 text-red-800';
                case 'Medium': return 'bg-yellow-100 border-yellow-300 text-yellow-800';
                case 'Low': return 'bg-green-100 border-green-300 text-green-800';
                default: return 'bg-gray-100 border-gray-300 text-gray-800';
            }
        }

        // --- Data Persistence (Local Storage) ---
        function saveData() {
            try {
                localStorage.setItem('cloudsoftInventory', JSON.stringify(inventory));
                localStorage.setItem('cloudsoftTasks', JSON.stringify(tasks));
                localStorage.setItem('cloudsoftExpenses', JSON.stringify(expenses));
                localStorage.setItem('cloudsoftCatalogueProducts', JSON.stringify(catalogueProductData)); // Save catalogue data
                autoSaveStatus.textContent = 'âœ“ Auto-save enabled (Local Storage)';
                autoSaveStatus.classList.remove('text-red-600');
                autoSaveStatus.classList.add('text-green-600');
            } catch (e) {
                console.error("Error saving data to local storage:", e);
                autoSaveStatus.textContent = 'âœ— Auto-save failed! Data might not be saved.';
                autoSaveStatus.classList.remove('text-green-600');
                autoSaveStatus.classList.add('text-red-600');
                showNotification('Failed to save data automatically. Please check browser storage.', 'error');
            }
        }

        function loadData() {
            showLoading('Loading your data...');
            try {
                const savedInventory = localStorage.getItem('cloudsoftInventory');
                const savedTasks = localStorage.getItem('cloudsoftTasks');
                const savedExpenses = localStorage.getItem('cloudsoftExpenses');
                const savedCatalogueProducts = localStorage.getItem('cloudsoftCatalogueProducts'); // Load catalogue data

                inventory = savedInventory ? JSON.parse(savedInventory) : [];
                tasks = savedTasks ? JSON.parse(savedTasks) : [];
                expenses = savedExpenses ? JSON.parse(savedExpenses) : [];
                catalogueProductData = savedCatalogueProducts ? JSON.parse(savedCatalogueProducts) : [ // Use default if no saved data
                    { id: 1, name: 'Toilet Paper', sheets: 350, plies: 2, price: 4.69, cp: 3.50, category: 'Toilet Paper' },
                    { id: 2, name: 'Toilet Paper', sheets: 200, plies: 2, price: 5.70, cp: 4.00, category: 'Toilet Paper' },
                    { id: 3, name: 'Toilet Paper', sheets: null, plies: 1, price: 6.23, cp: 4.50, category: 'Toilet Paper' },
                    { id: 4, name: 'Refuse Bags', sheets: null, plies: null, price: 18.70, cp: 12.00, category: 'Other' }
                ];

                showNotification('Data loaded successfully!', 'success');
            } catch (e) {
                console.error("Error loading data from local storage:", e);
                showNotification('Failed to load data from local storage. Starting fresh.', 'error');
                inventory = [];
                tasks = [];
                expenses = [];
                catalogueProductData = [ // Reset to default if error
                    { id: 1, name: 'Toilet Paper', sheets: 350, plies: 2, price: 4.69, cp: 3.50, category: 'Toilet Paper' },
                    { id: 2, name: 'Toilet Paper', sheets: 200, plies: 2, price: 5.70, cp: 4.00, category: 'Toilet Paper' },
                    { id: 3, name: 'Toilet Paper', sheets: null, plies: 1, price: 6.23, cp: 4.50, category: 'Toilet Paper' },
                    { id: 4, name: 'Refuse Bags', sheets: null, plies: null, price: 18.70, cp: 12.00, category: 'Other' }
                ];
            } finally {
                hideLoading();
                renderAllSections(); // Render all sections after loading data
            }
        }

        // --- Inventory Functions ---
        function addInventoryItem(name, quantity, category, cp, sp) {
            const newItem = {
                id: Date.now(),
                name,
                quantity: parseInt(quantity),
                category,
                costPrice: parseFloat(cp),
                sellingPrice: parseFloat(sp)
            };
            inventory.push(newItem);
            saveData();
            renderInventory();
            updateOverallFinancialSummary();
            showNotification('Inventory item added!', 'success');
        }

        function deleteInventoryItem(id) {
            inventory = inventory.filter(item => item.id !== id);
            saveData();
            renderInventory();
            updateOverallFinancialSummary();
            showNotification('Inventory item deleted.', 'info');
        }

        function renderInventory() {
            inventoryList.innerHTML = '';
            const searchTerm = searchInventory.value.toLowerCase();
            const filterCat = filterCategory.value;

            const filteredInventory = inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                      item.category.toLowerCase().includes(searchTerm);
                const matchesCategory = filterCat === '' || item.category === filterCat;
                return matchesSearch && matchesCategory;
            });

            if (filteredInventory.length === 0) {
                noInventoryMessage.classList.remove('hidden');
            } else {
                noInventoryMessage.classList.add('hidden');
                filteredInventory.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 fade-in';
                    const totalValue = (item.quantity * item.sellingPrice).toFixed(2);
                    row.innerHTML = `
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${item.category}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${item.quantity}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">R${item.costPrice.toFixed(2)}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">R${item.sellingPrice.toFixed(2)}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">R${totalValue}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteInventoryItem(${item.id})" class="text-red-600 hover:text-red-900 ml-2">Delete</button>
                        </td>
                    `;
                    inventoryList.appendChild(row);
                });
            }
            updateInventoryChart();
            totalInventoryCount.textContent = inventory.length;
        }

        function updateOverallFinancialSummary() {
            const totalCP = inventory.reduce((sum, item) => sum + (item.quantity * item.costPrice), 0);
            const totalSP = inventory.reduce((sum, item) => sum + (item.quantity * item.sellingPrice), 0);
            const totalExp = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSP - totalCP - totalExp;

            totalCostValue.textContent = `R${totalCP.toFixed(2)}`;
            totalSellingValue.textContent = `R${totalSP.toFixed(2)}`;
            totalExpensesValue.textContent = `R${totalExp.toFixed(2)}`;
            netProfitValue.textContent = `R${netProfit.toFixed(2)}`;
        }

        function updateInventoryChart() {
            const categoryValues = {};
            inventory.forEach(item => {
                if (!categoryValues[item.category]) {
                    categoryValues[item.category] = 0;
                }
                categoryValues[item.category] += item.quantity * item.sellingPrice;
            });

            const labels = Object.keys(categoryValues).map(label => wrapLabel(label));
            const data = Object.values(categoryValues);

            if (inventoryChart) {
                inventoryChart.data.labels = labels;
                inventoryChart.data.datasets[0].data = data;
                inventoryChart.update();
            } else {
                inventoryChart = new Chart(inventoryValueChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#6366F1', '#EC4899'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 20,
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed) {
                                            label += 'R' + context.parsed.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- Task Functions ---
        function addTask(description, dueDate, priority) {
            const newTask = {
                id: Date.now(),
                description,
                dueDate,
                priority,
                completed: false
            };
            tasks.push(newTask);
            saveData();
            renderTasks();
            showNotification('Task added!', 'success');
        }

        function toggleTaskCompletion(id) {
            tasks = tasks.map(task =>
                task.id === id ? { ...task, completed: !task.completed } : task
            );
            saveData();
            renderTasks();
            showNotification('Task status updated.', 'info');
        }

        function deleteTask(id) {
            tasks = tasks.filter(task => task.id !== id);
            saveData();
            renderTasks();
            showNotification('Task deleted.', 'info');
        }

        function renderTasks() {
            taskList.innerHTML = '';
            const filteredTasks = tasks.filter(task => {
                if (currentTaskFilter === 'all') return true;
                if (currentTaskFilter === 'pending') return !task.completed;
                if (currentTaskFilter === 'completed') return task.completed;
                if (currentTaskFilter === 'High') return task.priority === 'High';
                return true;
            });

            if (filteredTasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                filteredTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    const completedClass = task.completed ? 'opacity-60 line-through' : '';
                    const priorityColor = getPriorityColor(task.priority);
                    taskElement.className = `p-4 border border-gray-200 rounded-lg shadow-sm flex items-center justify-between transition-all fade-in ${completedClass}`;
                    taskElement.innerHTML = `
                        <div class="flex-1 mr-4">
                            <p class="text-lg font-medium text-gray-800">${task.description}</p>
                            <p class="text-sm text-gray-500 mt-1">Due: ${task.dueDate || 'N/A'} | Priority: <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${priorityColor}">${task.priority}</span></p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="toggleTaskCompletion(${task.id})" class="p-2 rounded-full ${task.completed ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white text-sm">
                                ${task.completed ? 'Undo' : 'Done'}
                            </button>
                            <button onclick="deleteTask(${task.id})" class="p-2 rounded-full bg-red-500 hover:bg-red-600 text-white text-sm">
                                Delete
                            </button>
                        </div>
                    `;
                    taskList.appendChild(taskElement);
                });
            }
        }

        // --- Expense Functions ---
        function addExpense(name, amount, date, category) {
            const newExpense = {
                id: Date.now(),
                name,
                amount: parseFloat(amount),
                date,
                category
            };
            expenses.push(newExpense);
            saveData();
            renderExpenses();
            updateOverallFinancialSummary();
            showNotification('Expense added!', 'success');
        }

        function deleteExpense(id) {
            expenses = expenses.filter(expense => expense.id !== id);
            saveData();
            renderExpenses();
            updateOverallFinancialSummary();
            showNotification('Expense deleted.', 'info');
        }

        function renderExpenses() {
            expenseList.innerHTML = '';
            if (expenses.length === 0) {
                noExpensesMessage.classList.remove('hidden');
            } else {
                noExpensesMessage.classList.add('hidden');
                expenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 fade-in';
                    row.innerHTML = `
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm font-medium text-gray-900">${expense.name}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${expense.category}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">R${expense.amount.toFixed(2)}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${expense.date}</td>
                        <td class="py-3 px-3 sm:px-6 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-900 ml-2">Delete</button>
                        </td>
                    `;
                    expenseList.appendChild(row);
                });
            }
        }

        // --- Catalogue Functions ---
        function addOrUpdateCatalogueProduct(name, sheets, plies, cp, price, category) {
            if (editingCatalogueProductId) {
                // Update existing product
                catalogueProductData = catalogueProductData.map(product => {
                    if (product.id === editingCatalogueProductId) {
                        return {
                            ...product,
                            name,
                            sheets: sheets ? parseInt(sheets) : null,
                            plies: plies ? parseInt(plies) : null,
                            cp: parseFloat(cp),
                            price: parseFloat(price),
                            category
                        };
                    }
                    return product;
                });
                showNotification('Catalogue product updated!', 'success');
            } else {
                // Add new product
                const newProduct = {
                    id: Date.now(),
                    name,
                    sheets: sheets ? parseInt(sheets) : null,
                    plies: plies ? parseInt(plies) : null,
                    cp: parseFloat(cp),
                    price: parseFloat(price),
                    category
                };
                catalogueProductData.push(newProduct);
                showNotification('Product added to catalogue!', 'success');
            }
            saveData();
            // Re-render the catalogue with the current filter applied
            const filteredProducts = catalogueProductData.filter(p => {
                if (currentCatalogueFilter === 'all') return true;
                return p.category === currentCatalogueFilter;
            });
            renderCatalogueProductCards(filteredProducts);
            renderOrUpdateCatalogueChart(filteredProducts);
            resetCatalogueForm(); // Reset form after add/update
        }

        function editCatalogueProduct(id) {
            const productToEdit = catalogueProductData.find(product => product.id === id);
            if (productToEdit) {
                catalogueProductName.value = productToEdit.name;
                catalogueSheets.value = productToEdit.sheets || '';
                cataloguePlies.value = productToEdit.plies || '';
                catalogueCostPrice.value = productToEdit.cp;
                catalogueSellingPrice.value = productToEdit.price;
                catalogueCategory.value = productToEdit.category;
                editingCatalogueProductId = id; // Set the ID of the product being edited

                catalogueFormTitle.textContent = 'Edit Catalogue Product';
                catalogueSubmitBtn.textContent = 'Update Product';
                catalogueSubmitBtn.classList.remove('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
                catalogueSubmitBtn.classList.add('from-purple-500', 'to-purple-600', 'hover:from-purple-600', 'hover:to-purple-700');
            }
        }

        function resetCatalogueForm() {
            catalogueProductForm.reset();
            editingCatalogueProductId = null; // Clear the editing state
            catalogueFormTitle.textContent = 'Add New Catalogue Product';
            catalogueSubmitBtn.textContent = 'Add Product to Catalogue';
            catalogueSubmitBtn.classList.remove('from-purple-500', 'to-purple-600', 'hover:from-purple-600', 'hover:to-purple-700');
            catalogueSubmitBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
        }

        function deleteCatalogueProduct(id) {
            catalogueProductData = catalogueProductData.filter(product => product.id !== id);
            saveData();
            // Re-render the catalogue with the current filter applied
            const filteredProducts = catalogueProductData.filter(p => {
                if (currentCatalogueFilter === 'all') return true;
                return p.category === currentCatalogueFilter;
            });
            renderCatalogueProductCards(filteredProducts);
            renderOrUpdateCatalogueChart(filteredProducts);
            showNotification('Catalogue product deleted.', 'info');
            resetCatalogueForm(); // Reset form in case deleted item was being edited
        }

        const renderCatalogueProductCards = (products) => {
            catalogueProductGrid.innerHTML = '';
            if (products.length === 0) {
                catalogueProductGrid.classList.add('hidden');
                catalogueNoResultsMessage.classList.remove('hidden');
                return;
            }
            
            catalogueProductGrid.classList.remove('hidden');
            catalogueNoResultsMessage.classList.add('hidden');

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-lg p-6 flex flex-col transition-transform duration-300 hover:scale-105';
                
                let specs = '';
                if (product.sheets) specs += `<span class="text-sm text-stone-500">${product.sheets} Sheets</span>`;
                if (product.plies) specs += `<span class="text-sm text-stone-500 ml-2">${product.plies}-Ply</span>`;
                if (specs === '') specs = '<span class="text-sm text-stone-500">Standard</span>';

                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-slate-800">${product.name}</h3>
                        <div class="my-2">${specs}</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-stone-200 flex justify-between items-center">
                        <div>
                            <p class="text-sm text-stone-600">Cost Price</p>
                            <p class="text-xl font-bold text-red-700">R${product.cp.toFixed(2)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-stone-600">Selling Price</p>
                            <p class="text-3xl font-bold text-green-700">R${product.price.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex justify-between gap-2 mt-4">
                        <button onclick="editCatalogueProduct(${product.id})" class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors duration-300 shadow-md">
                            Edit
                        </button>
                        <button onclick="deleteCatalogueProduct(${product.id})" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors duration-300 shadow-md">
                            Delete
                        </button>
                    </div>
                `;
                catalogueProductGrid.appendChild(card);
            });
        };

        const renderOrUpdateCatalogueChart = (products) => {
            const ctx = cataloguePriceChartCanvas.getContext('2d');
            
            // Destroy existing chart instance if it exists to ensure proper re-rendering on a visible canvas
            if (cataloguePriceChart) {
                cataloguePriceChart.destroy();
                cataloguePriceChart = null; // Reset the chart instance
            }

            const labels = products.map(p => {
                let label = p.name;
                if(p.sheets) label += ` ${p.sheets}s`;
                if(p.plies) label += ` ${p.plies}p`;
                const maxLength = 16;
                if (label.length > maxLength) {
                    const words = label.split(' ');
                    let lines = [];
                    let currentLine = '';
                    for (const word of words) {
                        if ((currentLine + ' ' + word).length > maxLength) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine += ' ' + word;
                        }
                    }
                    lines.push(currentLine);
                    return lines.map(l => l.trim());
                }
                return label;
            });
            const sellingPriceData = products.map(p => p.price);
            const costPriceData = products.map(p => p.cp);

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Cost Price (R)',
                        data: costPriceData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)', // Tailwind red-500
                        borderColor: 'rgba(220, 38, 38, 1)', // Tailwind red-700
                        borderWidth: 1,
                        borderRadius: 8,
                    },
                    {
                        label: 'Selling Price (R)',
                        data: sellingPriceData,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)', // Tailwind green-500
                        borderColor: 'rgba(5, 150, 105, 1)', // Tailwind green-700
                        borderWidth: 1,
                        borderRadius: 8,
                    }
                ]
            };

            // Re-create the chart
            cataloguePriceChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true, // Display legend for two datasets
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `R${context.parsed.y.toFixed(2)}`;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price (ZAR)'
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        };
        
        const handleCatalogueFilterClick = (e) => {
            currentCatalogueFilter = e.target.dataset.filter;
            
            catalogueFilterButtons.forEach(button => {
                if (button.dataset.filter === currentCatalogueFilter) {
                    button.classList.remove('bg-white', 'text-slate-700');
                    button.classList.add('bg-slate-700', 'text-white');
                } else {
                    button.classList.remove('bg-slate-700', 'text-white');
                    button.classList.add('bg-white', 'text-slate-700');
                }
            });

            const filteredProducts = catalogueProductData.filter(p => {
                if (currentCatalogueFilter === 'all') return true;
                return p.category === currentCatalogueFilter;
            });

            renderCatalogueProductCards(filteredProducts);
            renderOrUpdateCatalogueChart(filteredProducts);
        };

        // --- Section Switching Logic ---
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active navigation button styles
            document.querySelectorAll('#main-nav button').forEach(button => {
                button.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700', 'text-white', 'shadow-md');
                button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });

            const activeButton = document.getElementById(`nav-${sectionId.replace('-section', '')}`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                activeButton.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700', 'text-white', 'shadow-md');
            }

            // Re-render relevant section data when shown
            if (sectionId === 'inventory-section') {
                renderInventory();
                updateOverallFinancialSummary();
            } else if (sectionId === 'tasks-section') {
                renderTasks();
            } else if (sectionId === 'expenses-section') {
                renderExpenses();
                updateOverallFinancialSummary();
            } else if (sectionId === 'catalogue-section') {
                // Ensure the correct filter button is highlighted and content is rendered
                handleCatalogueFilterClick({ target: { dataset: { filter: currentCatalogueFilter } } });
            }
        }

        // --- Event Listeners ---
        inventoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const productName = document.getElementById('productName').value;
            const quantity = document.getElementById('quantity').value;
            const category = document.getElementById('category').value;
            const cp = document.getElementById('costPrice').value;
            const sp = document.getElementById('sellingPrice').value;
            addInventoryItem(productName, quantity, category, cp, sp);
            inventoryForm.reset();
        });

        searchInventory.addEventListener('input', renderInventory);
        filterCategory.addEventListener('change', renderInventory);
        clearFilters.addEventListener('click', () => {
            searchInventory.value = '';
            filterCategory.value = '';
            renderInventory();
        });

        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;
            addTask(description, dueDate, priority);
            taskForm.reset();
        });

        filterAllTasks.addEventListener('click', () => { currentTaskFilter = 'all'; renderTasks(); });
        filterPendingTasks.addEventListener('click', () => { currentTaskFilter = 'pending'; renderTasks(); });
        filterCompletedTasks.addEventListener('click', () => { currentTaskFilter = 'completed'; renderTasks(); });
        filterHighTasks.addEventListener('click', () => { currentTaskFilter = 'High'; renderTasks(); });

        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const expenseName = document.getElementById('expenseName').value;
            const expenseAmount = document.getElementById('expenseAmount').value;
            const expenseDate = document.getElementById('expenseDate').value;
            const expenseCategory = document.getElementById('expenseCategory').value;
            addExpense(expenseName, expenseAmount, expenseDate, expenseCategory);
            expenseForm.reset();
        });

        // Event listener for the catalogue product form submission (now handles both add and update)
        catalogueProductForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = catalogueProductName.value;
            const sheets = catalogueSheets.value;
            const plies = cataloguePlies.value;
            const cp = catalogueCostPrice.value;
            const price = catalogueSellingPrice.value;
            const category = catalogueCategory.value;
            addOrUpdateCatalogueProduct(name, sheets, plies, cp, price, category);
        });

        navInventory.addEventListener('click', () => showSection('inventory-section'));
        navCatalogue.addEventListener('click', () => showSection('catalogue-section'));
        navTasks.addEventListener('click', () => showSection('tasks-section'));
        navExpenses.addEventListener('click', () => showSection('expenses-section'));

        // Catalogue filter buttons
        catalogueFilterButtons.forEach(button => button.addEventListener('click', handleCatalogueFilterClick));

        mobileMenuToggle.addEventListener('click', () => {
            mainNav.classList.toggle('mobile-nav-hidden');
            mainNav.classList.toggle('mobile-nav-show');
        });

        // Export/Import functionality
        exportDataBtn.addEventListener('click', () => {
            showLoading('Exporting data...');
            setTimeout(() => { // Simulate loading
                const dataToExport = {
                    inventory: inventory,
                    tasks: tasks,
                    expenses: expenses,
                    catalogueProducts: catalogueProductData // Export catalogue data
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cloudsoft_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                hideLoading();
                showNotification('Data exported successfully!', 'success');
            }, 500);
        });

        importDataBtn.addEventListener('click', () => {
            importFileInput.click();
        });

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                showLoading('Importing data...');
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        inventory = importedData.inventory || [];
                        tasks = importedData.tasks || [];
                        expenses = importedData.expenses || [];
                        catalogueProductData = importedData.catalogueProducts || []; // Import catalogue data
                        saveData(); // Save imported data to local storage
                        renderAllSections();
                        showNotification('Data imported successfully!', 'success');
                    } catch (error) {
                        console.error("Error parsing imported file:", error);
                        showNotification('Failed to import data. Invalid file format.', 'error');
                    } finally {
                        hideLoading();
                    }
                };
                reader.onerror = () => {
                    showNotification('Failed to read file.', 'error');
                    hideLoading();
                };
                reader.readAsText(file);
            }
        });

        // PDF Export functionality
        exportDataBtn.addEventListener('click', () => {
            showLoading('Generating PDF...');
            setTimeout(() => { // Simulate PDF generation time
                // Ensure financial summary is up-to-date right before PDF generation
                updateOverallFinancialSummary(); 

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let yPos = 10;

                // Title
                doc.setFontSize(20);
                doc.text("Cloudsoft Business Report", 10, yPos);
                yPos += 10;

                // Date
                doc.setFontSize(10);
                doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 10, yPos);
                yPos += 10;

                // Financial Summary
                doc.setFontSize(16);
                doc.text("Financial Summary", 10, yPos);
                yPos += 7;
                doc.setFontSize(12);
                doc.text(`Total Cost Value: R${totalCostValue.textContent.replace('R', '')}`, 10, yPos);
                doc.text(`Total Selling Value: R${totalSellingValue.textContent.replace('R', '')}`, 80, yPos);
                yPos += 7;
                doc.text(`Total Expenses: R${totalExpensesValue.textContent.replace('R', '')}`, 10, yPos);
                doc.text(`Net Profit: R${netProfitValue.textContent.replace('R', '')}`, 80, yPos);
                yPos += 15;

                // Inventory Table
                doc.setFontSize(16);
                doc.text("Inventory Items", 10, yPos);
                yPos += 7;
                const inventoryHeaders = [['Product Name', 'Category', 'Quantity', 'Cost Price (R)', 'Selling Price (R)', 'Total Value (R)']];
                const inventoryData = inventory.map(item => [
                    item.name,
                    item.category,
                    item.quantity,
                    item.costPrice.toFixed(2),
                    item.sellingPrice.toFixed(2),
                    (item.quantity * item.sellingPrice).toFixed(2)
                ]);
                doc.autoTable({
                    startY: yPos,
                    head: inventoryHeaders,
                    body: inventoryData,
                    theme: 'striped',
                    headStyles: { fillColor: [51, 65, 85] }, // Tailwind slate-700 equivalent
                    styles: { fontSize: 8, cellPadding: 2 },
                    margin: { top: 5, bottom: 5, left: 10, right: 10 },
                    didDrawPage: function (data) {
                        yPos = data.cursor.y;
                    }
                });
                yPos = doc.autoTable.previous.finalY + 15;

                // Tasks Table
                if (tasks.length > 0) {
                    doc.addPage();
                    yPos = 10;
                    doc.setFontSize(16);
                    doc.text("Tasks List", 10, yPos);
                    yPos += 7;
                    const taskHeaders = [['Description', 'Due Date', 'Priority', 'Completed']];
                    const taskData = tasks.map(task => [
                        task.description,
                        task.dueDate || 'N/A',
                        task.priority,
                        task.completed ? 'Yes' : 'No'
                    ]);
                    doc.autoTable({
                        startY: yPos,
                        head: taskHeaders,
                        body: taskData,
                        theme: 'striped',
                        headStyles: { fillColor: [51, 65, 85] },
                        styles: { fontSize: 8, cellPadding: 2 },
                        margin: { top: 5, bottom: 5, left: 10, right: 10 },
                        didDrawPage: function (data) {
                            yPos = data.cursor.y;
                        }
                    });
                    yPos = doc.autoTable.previous.finalY + 15;
                }

                // Expenses Table
                if (expenses.length > 0) {
                    doc.addPage();
                    yPos = 10;
                    doc.setFontSize(16);
                    doc.text("Expenses List", 10, yPos);
                    yPos += 7;
                    const expenseHeaders = [['Name', 'Category', 'Amount (R)', 'Date']];
                    const expenseData = expenses.map(expense => [
                        expense.name,
                        expense.category,
                        expense.amount.toFixed(2),
                        expense.date
                    ]);
                    doc.autoTable({
                        startY: yPos,
                        head: expenseHeaders,
                        body: expenseData,
                        theme: 'striped',
                        headStyles: { fillColor: [51, 65, 85] },
                        styles: { fontSize: 8, cellPadding: 2 },
                        margin: { top: 5, bottom: 5, left: 10, right: 10 },
                        didDrawPage: function (data) {
                            yPos = data.cursor.y;
                        }
                    });
                }

                // Catalogue Products Table
                if (catalogueProductData.length > 0) {
                    doc.addPage();
                    yPos = 10;
                    doc.setFontSize(16);
                    doc.text("Catalogue Products", 10, yPos);
                    yPos += 7;
                    const catalogueHeaders = [['Product Name', 'Sheets', 'Plies', 'Cost Price (R)', 'Selling Price (R)', 'Category']];
                    const catalogueData = catalogueProductData.map(product => [
                        product.name,
                        product.sheets || 'N/A',
                        product.plies || 'N/A',
                        product.cp.toFixed(2),
                        product.price.toFixed(2),
                        product.category
                    ]);
                    doc.autoTable({
                        startY: yPos,
                        head: catalogueHeaders,
                        body: catalogueData,
                        theme: 'striped',
                        headStyles: { fillColor: [51, 65, 85] },
                        styles: { fontSize: 8, cellPadding: 2 },
                        margin: { top: 5, bottom: 5, left: 10, right: 10 },
                        didDrawPage: function (data) {
                            yPos = data.cursor.y;
                        }
                    });
                }


                doc.save('Cloudsoft_Business_Report.pdf');
                hideLoading();
                showNotification('PDF generated successfully!', 'success');
            }, 1000); // Simulate network delay
        });


        // --- Initialization ---
        function renderAllSections() {
            // Render Inventory
            renderInventory();
            updateOverallFinancialSummary();

            // Render Tasks
            renderTasks();

            // Render Expenses
            renderExpenses();

            // The catalogue section will be rendered when its tab is clicked
            // Initial render for catalogue to show default or loaded data
            handleCatalogueFilterClick({ target: { dataset: { filter: currentCatalogueFilter } } });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            showSection('inventory-section'); // Default to inventory section on load
        });

    </script>
</body>
</html>


